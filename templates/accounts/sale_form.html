{% extends 'base.html' %}
{% load widget_tweaks %}
{% block content %}
<h2>{% if object %}تعديل عملية بيع{% else %}إضافة عملية بيع جديدة{% endif %}</h2>

<form method="post" id="saleForm">
    {% csrf_token %}
    {% if form.errors %}
    <div class="alert alert-danger">
        {% for field, errors in form.errors.items %}
            <strong>{{ field }}:</strong>
            {% for error in errors %}
                {{ error }}
            {% endfor %}
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="form-group text-right">
        <label>التاريخ:</label>
        <input type="date" name="date" class="form-control" value="{{ object.date|date:'Y-m-d' }}" required>
    </div>
    
    <div class="form-group text-right">
        <label>العميل:</label>
        {{ form.client }}
    </div>
    
    <div class="form-group text-right">
        <label>نوع الزيت:</label>
        {{ form.oil_type }}
    </div>
    
    <div class="form-group text-right">
        <label>الكمية (طن):</label>
        {{ form.quantity|add_class:"form-control"|attr:"step=0.01 min=0" }}
    </div>
    
    <div class="form-group text-right">
        <label>سعر الطن:</label>
        {{ form.price|add_class:"form-control"|attr:"step=0.01 min=0" }}
    </div>
    
    <div class="form-group text-right">
        <label>مكان التحميل:</label>
        {{ form.loading_location }}
    </div>
    
    <div class="form-group text-right">
        <label>مكان التفريغ:</label>
        {{ form.unloading_location }}
    </div>
    
    <div class="form-group text-right">
        <label>السائق:</label>
        {{ form.driver }}
    </div>
    
    <div class="form-group text-right">
        <label>رقم السيارة:</label>
        <span id="vehicleDisplay" class="form-control-plaintext">{{ object.vehicle|default:'' }}</span>
    </div>
    
    <button type="submit" class="btn btn-primary">حفظ</button>
    <a href="{% url 'sale_list' %}" class="btn btn-secondary">إلغاء</a>
</form>

<script>
$(document).ready(function() {
    // Dynamic total calculation
    $('#id_quantity, #id_price').on('input', function() {
        let quantity = parseFloat($('#id_quantity').val()) || 0;
        let price = parseFloat($('#id_price').val()) || 0;
        $('#id_total').val((quantity * price).toFixed(3));
    });

    // Vehicle number auto-display
    $('#id_driver').change(function() {
        $('#vehicleDisplay').text('');
        let driverId = $(this).val();
        if (!driverId) return;
        if (driverId) {
            $.ajax({
                url: `/accounts/api/drivers/${driverId}/vehicle/`,
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                success: function(data) {
                    $('#vehicleDisplay').text(data.vehicle_number || 'غير متوفر');
                    // Update the vehicle_number field value
                    if ($('#id_vehicle_number').length) {
                        // If the field exists, update its value
                        $('#id_vehicle_number').val(data.vehicle_number || '');
                    } else {
                        // If the field doesn't exist, create it
                        $('<input>').attr({
                            type: 'hidden',
                            id: 'id_vehicle_number',
                            name: 'vehicle_number',
                            value: data.vehicle_number || ''
                        }).appendTo('form');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching vehicle data:', error);
                    $('#vehicleDisplay').text('خطأ في جلب البيانات');
                }
            });
        }
    });
});
</script>
{% endblock %}